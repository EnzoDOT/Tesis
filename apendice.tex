\pagestyle{fancy}
\chapter*{Apéndice}
\lhead{\thepage}
\rhead{\textit{Apéndice}}
\vspace{0.01\textheight}
\addcontentsline{toc}{chapter}{Apéndice}
\chapter{La aproximación de difusión}
\label{ap:ecdiff}

El modelo físico mas utilizado para el modelado del transporte de fotones en el 
tejido biológico se basa en la utilización de la aproximación de 
difusión a la ETR~\eqref{eq:RTE}. La razón por la cual este modelo es más utilizado 
que la ecuación de transporte radiativo (la cual 
provee un modelo físicamente preciso para el transporte de los fotones a escala mesoscópica, 
siendo la aproximación de difusión sólo una aproximación a esta última), es que 
por un lado, el tejido biológico es un medio 
altamente dispersivo donde en ciertas circunstancias la ecuación de difusión para los fotones permite obtener valores aproximados para el flujo de fotones, resolviendo un problema matemáticamente 
más simple (la ecuación de difusión), y con un costo computacional 
considerablemente menor que el que exige la resolución de la ETR. 
Si se considera el problema ETR dependiente del tiempo 
en tres dimensiones espaciales, la solución a este problema, $\ut=u(x,y,z,\tilde{\theta},\varphi,t)$  
posee 6 variables independientes, donde a las tres variables espaciales $\x=(x,y,z)$, 
deben agregarse las direcciones de propagación en la esfera unitaria $S^2$, las 
cuales para ser determinadas, exigen de dos variables direccionales, con $\hth=\hth(\theta,\varphi)=\cos(\varphi)\sin(\tilde{\theta})\hat x+\sin(\varphi)\sin(\tilde{\theta})\hat y+\cos(\tilde{\theta}) \hat z$, y adicionalmente se tiene la variable temporal $t$. En 3D, utilizaremos 
la integración de ángulo sólido, con el elemento diferencial definido según 
$d\theta= d\varphi \sin(\tilde{\theta}) d\tilde{\theta}$, 
donde ahora utilizamos la variable $\tilde{\theta}$ para la integración en el angulo polar, 
para distinguirla de la variable de integración azimutal que usamos en los problemas de simetría 2D, y de la nueva variable de angulo sólido $d\theta$ que utilizamos en esta sección. Bajo la aproximación 
de difusión se reduce la dimensionalidad del problema, que pasa a depender en sólo 4 variables. 
Esto es posible si se asume que, para medios donde domina la dispersión, 
la intensidad específica $u(\x,\hth,t)$ será aproximadamente 
isótropa (\ie, variará suavemente en la variable $\hth$), 
de forma tal que se eliminará la dependencia direccional. Para que la 
ecuación de difusión sea una buena aproximación a la ecuación de 
transporte, se exige que $b(\x)\gg a(\x)$. Cabe destacar que esta aproximación 
es valida en el interior del dominio. Cerca de los bordes, como vimos en la sección~\ref{sec:blayer}, existirán capas límite exponenciales. 
En particular, en las cercanías del borde del dominio, la intensidad específica no será isótropa, 
aún si las condiciones de borde y las fuentes consideradas lo son (ver fig.~\ref{fig:ansol} 
en la sección~\ref{sec:blayer}, y la discusión allí dada), 
debido a que para las direcciones salientes, la intensidad específica 
presentara valores en cierta medida ``arbitrarios'', mientras que 
para las direcciones entrantes la intensidad específica debe satisfacer 
las condiciones de borde impuestas. Tampoco será válida esta 
aproximación en la cercanía de fuentes colimadas, que presenten variaciones no lineales en la variable 
direccional $\hth$. Por este motivo, si bien no haremos las consideraciones correspondientes 
en detalle, debe tenerse en cuenta que la aproximación de difusión que discutiremos, 
será válida en el interior del dominio $\Omega$, y lejos de fuentes no isótropas. 

Existen diferentes formas 
de llegar a la ecuación de difusión. Una de ellas se basa en  una expansión perturbativa~\cite{Larsen1974,Larsen1987,Arridge2009}, 
donde se exige que la dispersión sea dominante. En particular, se exige qué $b(\x) \gg a(\x)$, 
y que el camino libre medio de dispersión, definido como $\ell_b=b(\x)^{-1}$, cumpla $\ell_b\ll \mathcal{L}$, 
donde $\mathcal{L}$ denota una distancia característica del problema en consideración. 
Este último requerimiento, físicamente implica que para las distancias del problema (donde $\mathcal{L}$ 
podría ser por ejemplo, la dimensión de los lados de los dominios $\Omega$ considerados anteriormente) las partículas realizarán un número muy grande de colisiones, entrando, por lo tanto, en el régimen difusivo. La expansión perturbativa se realiza utilizando las variables 
reescaleadas $a(\x) \rightarrow \varepsilon a(\x)$, $b(\x) \rightarrow \frac{b(\x)}{\varepsilon}$, $s(\x,\hth,t)\rightarrow  \varepsilon s(\x,\hth,t)$ y $t\rightarrow \frac{t}{\varepsilon}$, con $\varepsilon \ll 1$. Estas variables  expresan físicamente que la dispersión es el fenómeno dominante para las 
escalas espaciales y temporales consideradas. Reemplazando en la ec.~\eqref{eq:RTE} estas variables, junto con la expansión perturbativa $\ut=u_0(\x,\hth,t)+\varepsilon u_1(\x,\hth,t)+\varepsilon^2 u_2(\x,\hth,t)+\ldots$ e igualando los términos del mismo orden en $\varepsilon$ 
hasta el orden cuadrático, se obtiene la ecuación de difusión. Deben realizarse consideraciones especiales con respecto a las condiciones de 
borde que son tratadas en la literatura, y que no detallaremos aquí. Cabe destacar que en la proximidad de los bordes, las partículas no habrán realizado suficientes colisiones para entrar en el régimen difusivo, por lo cual, nuevamente el análisis detallado vale en el interior del dominio espacial $\Omega$. 

Existen otras formas de derivar la ecuación de difusión para los fotones. 
Si se multiplica la versión 3D de la ETR  por la variable angular $\hth$, y se integra 
sobre esa misma variable, se tiene
\begin{equation}
\begin{split}
\begin{aligned}
\frac{1}{c}\frac{\partial}{\partial t} \jc+\int_{S^2} d\theta \nabla & \ut \cdot \hth \hth 
+[a(\x)+b(\x)]\jc=\\
&b(\x)\int_{S^2} \hth d\theta \int_{S^2} \eta(\hth \cdot \hth')  u(\x,\hth',t) d\theta' + s_1(\x,t),
\end{aligned}
\end{split}
\label{eq:RTEjflux}
\end{equation}
donde $s_1(\x,t)$ viene dado por el primer momento de la fuente, y utilizamos 
la versión 3D de la corriente de fotones (ec.~\eqref{eq:photoncurrent})
\begin{equation}
\begin{split}
\begin{aligned}
s_1(\x,t)&=\int_{S^2} \hth s(\x,\hth,t) d\theta,\\
 \jc&=\int_{S^2} \hth \ut d\theta,
\label{eq:RTEsflux1}
\end{aligned}
\end{split}
\end{equation}
donde considerando el caso mas general de tres dimensiones espaciales, integramos en la esfera unitaria $S^2$ donde quedan definidas todas las direcciones posibles de propagación en 3D. 
De la formula de Lagrange para el producto de tres vectores $\vec{v_1} \times \vec{v_2} \times \vec{v_3}=(\vec{v_1}\cdot \vec{v_3}) \vec{v_2}-(\vec{v_1} \cdot \vec{v_2}) \vec{v_3}$ 
se tiene qué  $\hth= \hth'(\hth\cdot \hth') + \hth' \times(\hth \times \hth')$.
Utilizando la ultima identidad reescribimos la primer integral en el lado derecho de la ecuación~\eqref{eq:RTEjflux} como
\begin{equation}
\begin{split}
\begin{aligned}
\int_{S^2} \hth d\theta \int_{S^2} \eta(\hth \cdot \hth')  u(\x,\hth',t) d\theta' 
&=\int_{S^2} u(\x,\hth',t) d\theta'  \int_{S^2} \hth \eta(\hth \cdot \hth') d\theta\\
&=\int_{S^2} u(\x,\hth',t) d\theta' \int_{S^2} \hth' (\hth \cdot \hth') \eta(\hth \cdot \hth') d\theta \\&\quad+ \int_{S^2} u(\x,\hth',t) d\theta' \int_{S^2}  \hth' \times(\hth \times \hth') \eta(\hth \cdot \hth') d\theta .
\end{aligned}
\end{split}
\label{eq:RTEjint}
\end{equation}
Debido a que la función de fase sólo depende del ángulo entre 
la dirección incidente y la dirección en la que el fotón es dispersado ($\cos(\alpha)=\hth \cdot \hth'$), la última integral en~\eqref{eq:RTEjint} se anula
\begin{equation}
\begin{split}
\begin{aligned}
\int_{S^2}  \hth' \times(\hth \times \hth') \eta(\hth \cdot \hth') d\theta =0.
\end{aligned}
\end{split}
\label{eq:RTEjint2}
\end{equation}
Reordenando los términos, y usando qué
el factor de anisotropía para la función de Henyey-Greenstein, $\eta(\hth \cdot \hth')$ viene dado por 
\begin{equation}
g=\int_{S^2} \hth \cdot \hth' \eta(\hth \cdot \hth') d\theta,
\label{eq:gnorm}
\end{equation}
se tiene 
\begin{equation}
\begin{split}
\begin{aligned}
\int_{S^2} \hth d\theta \int_{S^2} \eta(\hth \cdot \hth')  u(\x,\hth',t) d\theta' 
=g \jc
\end{aligned}
\end{split}
\label{eq:RTEjint}
\end{equation}

Llamando al segundo momento de $\ut$
\begin{equation}
\bar{\mathcal{J}}_2(\x,t)=\int_{S^2} \hth \hth \ut d\theta,
\label{eq:RTEjflux2}
\end{equation}
y la ecuación~\eqref{eq:RTEjflux} puede reescribirse como
\begin{equation}
\begin{split}
\begin{aligned}
\frac{1}{c}\frac{\partial}{\partial t} \jc+\nabla \cdot \bar{\mathcal{J}}_2(\x,t)+[a(\x)+b'(\x)]\jc=s_1(\x,t),
\end{aligned}
\end{split}
\label{eq:RTEjfluxf}
\end{equation}
donde el coeficiente de dispersión reducido viene dado por $b'(\x)=(1-g)b(\x)$.

Adicionalmente, tenemos de la ec.~\eqref{eq:RTEscflux} para el flujo escalar, la cual derivamos en la 
sección~\ref{sec:ETR} para el caso 2D, que reescribimos aquí considerando un domino $\Omega \in \mathbb{R}^3$
\begin{equation}
\frac{1}{c}\frac{\partial}{\partial t} \phi(\x,t)+\nabla \cdot \vec{ \mathcal{J}}(\x,t)
+a(\x)\phi(\x,t)=s_0(\x,t).
\label{eq:RTEscfluxap}
\end{equation}
Como se mencionó anteriormente, esta ecuación representa la conservación 
de los fotones para cada punto espacial $\x \in \Omega$, independientemente 
de la dirección. Hasta este punto no hemos realizado ninguna aproximación. 
Si en la ec.~\eqref{eq:RTEscfluxap} logramos eliminar $\jc$, tendremos una ecuación diferencial 
para el flujo escalar $\phi(\x,t)$. Buscaremos eliminar $\jc$ aplicando algunas aproximaciones en la ec.~\eqref{eq:RTEjfluxf} que nos permitan obtener una relación entre $\jc$ y $\phi(\x,t)$.

El enfoque utilizado con mayor frecuencia en la literatura de tomografía óptica para la derivación de la aproximación de difusión se basa 
en la denominada aproximación $P_N$ de la ETR~\cite{Arridge2009,Wang2009}. Dado que la dispersión tiende a promediar la función de distribución $\ut$ con respecto a la variable $\hth$, volviéndola isótropa, es esperable que en el régimen difusivo la función $u(\x,\hth,t)$ varíe suavemente como función de la variable angular $\hth$. En general, como se vio en la sección~\ref{sec:blayer} esto no será cierto en la proximidad de los bordes. Lejos de los bordes, la variación suave de $\ut$ en $\hth$ para problemas difusivos invita a realizar la expansión en armónicos esféricos
\begin{equation}
\begin{split}
\begin{aligned}
u(\x,\hth,t)&\sim \sum_{l=0}^{N}\sum_{m=-l}^lu_{l,m}(\x,t)Y_{l,m}(\tilde{\theta},\varphi), \\ 
u_{l,m}(\x,t)&=\int_{0}^{2\pi} d\varphi \int_0^{\pi} d\tilde{\theta} \sin (\tilde{\theta})  u(\x,\tilde{\theta},\varphi,t) Y_{l,m}(\tilde{\theta},\varphi) ,
\end{aligned}
\end{split}
\label{eq:PN}
\end{equation}
donde $Y_{l,m}(\tilde{\theta},\varphi)$ representa al armónico esférico de grado $l$ y orden $m$~\cite{Sansone1991}. La relación~\eqref{eq:PN} valdrá, en general, para $N \rightarrow \infty$. Cuando, debido a la alta dispersión, la función $u(\x,\hth,t)$ 
varíe suavemente en la variable $\hth$, un truncamiento con un valor 
finito de $N$ en la ec.~\eqref{eq:PN} brindará una buena aproximación 
a la solución de la ETR.
Reemplazando esta propuesta en la ecuación ETR lleva a un sistema de ecuaciones acopladas, cuyo primer orden, bajo ciertas aproximaciones, da como resultado la ecuación de difusión. También puede obtenerse la aproximación de difusión considerando las ecuaciones~\eqref{eq:RTEjfluxf} y ~\eqref{eq:RTEscfluxap}. Si bien se espera que, debido a la dispersión, la intensidad específica sea una función isótropa, la dependencia angular no puede ser constante, ya que en tal caso 
no podría haber flujo neto de radiación~\cite[cap. 9, p. 176]{Ishimaru1978}. Por esta razón consideraremos la expansión~\eqref{eq:PN} con $N=1$. 
Es fácil mostrar qué
\begin{equation}
\begin{split}
\begin{aligned}
u_{0,0}(\x,t) Y_{0,0}(\tilde{\theta},\varphi) &=\frac{\phi(\x,t)}{4\pi},\\
\frac{4\pi}{3} \sum_{m=-1}^1 u_{1,m}(\x,t)Y_{1,m} (\tilde{\theta},\varphi) & = \frac{3}{4\pi} \jc \cdot \hth,
\end{aligned}
\end{split}
\label{eq:PN2}
\end{equation}
de donde se tiene de~\eqref{eq:PN} a primer orden
\begin{equation}
\begin{split}
\begin{aligned}
u(\x,\hth,t)&\sim \frac{\phi(\x,t)}{4\pi}+\frac{3}{4\pi} \jc \cdot \hth.
\end{aligned}
\end{split}
\label{eq:PN3}
\end{equation}
Reemplazando~\eqref{eq:PN3} en~\eqref{eq:RTEjflux2} tenemos
\begin{equation}
\bar{\mathcal{J}}_2(\x,t)=\int_{S^2} \hth \hth \left(  \frac{\phi(\x,t)}{4\pi}+\frac{3}{4\pi} \jc \cdot \hth \right) d\theta.
\label{eq:RTEjflux22}
\end{equation}
Dado que el flujo escalar $\phi(\x,t)$ y la corriente $\jc$ no dependen de la variable $\hth$, las integrales que 
constituyen los elementos del tensor de segundo orden $\bar{\mathcal{J}}_2(\x,t)$ están formadas 
por productos de potencias de funciones trigonométricas que pueden ser evaluadas fácilmente. 
Es fácil verificar que la integral en el segundo término del lado derecho de la ecuación~\eqref{eq:RTEjflux22} se anula, y qué~\cite[cap. 17, p. 544]{Modest2013}
\begin{equation}
\int_{S^2} \hth \hth d\theta=\frac{4\pi}{3} \id,
\label{eq:RTEjflux23}
\end{equation}
de donde se tiene 
\begin{equation}
\nabla \cdot \bar{\mathcal{J}}_2(\x,t)=\frac{1}{3}\nabla \phi(\x,t).
\label{eq:RTEjflux24}
\end{equation}
Asumiendo que la fuente $s(\x,\hth,t)$ es isótropa, se tendrá $s_1(\x,t)= 0$. Reemplazando estos resultados en la ecuación~\eqref{eq:RTEjfluxf}
\begin{equation}
\begin{split}
\begin{aligned}
\frac{1}{c}\frac{\partial}{\partial t} \jc+\frac{1}{3}\nabla  \phi(\x,t) +[a(\x)+b'(\x)]\jc=0.
\end{aligned}
\end{split}
\label{eq:RTEjfluxf3}
\end{equation}
Además, considerando que el tiempo que le toma a los fotones en recorrer 
el camino libre medio ocurre en escalas temporales mucho 
mas pequeñas que las consideradas para las variaciones temporales de $\jc$, se 
tiene qué $\frac{1}{c}\frac{\partial}{\partial t} \jc \simeq 0$, de donde de 
la ec.~\eqref{eq:RTEjfluxf3} se llega a la Ley de Fick
\begin{equation}
\begin{split}
\begin{aligned}
\jc=-\frac{1}{3[a(\x)+b'(\x)]} \nabla  \phi(\x,t) ,
\end{aligned}
\end{split}
\label{eq:Fick}
\end{equation}
donde el signo negativo expresa que el flujo de fotones se da desde regiones 
de mayor densidad (o ``concentración'') hacia regiones de menor densidad de fotones. 
Definiendo el coeficiente de difusión $D(\x)=\frac{1}{3[a(\x)+b'(\x)]}$, y reemplazando 
este último resultado en la ecuación~\eqref{eq:RTEscfluxap}, se 
llega finalmente a la ecuación de difusión para la densidad de fotones
\begin{equation}
\frac{1}{c}\frac{\partial}{\partial t} \phi(\x,t)-\nabla \cdot \left( D(\x) \nabla  \phi(\x,t) \right)
+a(\x)\phi(\x,t)=s_0(\x,t).
\label{eq:difusion}
\end{equation}
Las condiciones de borde que deben ser impuestas en la ecuación~\eqref{eq:difusion} 
merecen un capitulo a parte, y escapan al alcance de esta tesis. 
Esta aproximación puede considerarse aproximadamente válida para el régimen difusivo de la ecuación 
de transporte en un medio infinito. Se han 
reportado diferencias significativas entre los resultados obtenidos para el 
flujo de fotones resultante de la ecuación~\eqref{eq:difusion} y el obtenido 
mediante uso de la ecuación~\eqref{eq:RTE} aún 
en el régimen difusivo, y lejos de las fuentes~\cite{Hielscher1998}. Como se mencionó anteriormente, 
la aproximación de difusión en el régimen difusivo, es en general, válida en lejanías 
de los bordes. Se han desarrollado diferentes teorías para el tratamiento de las 
condiciones de borde que deben imponerse en la ecuación~\eqref{eq:difusion}, 
que incluyen la utilización de bordes extrapolados, así como condiciones de borde de Robin que resultan de hacer consideraciones para el flujo de fotones, que resultan de integrar las condiciones de borde impuestas en la ETR~\cite{Arridge2009,Haskell1994,Ishimaru1978,Arridge1999,Xu2002}. En general, en la bibliografía 
no se discute el tratamiento adecuado de las capas límite discutidas en la sección~\ref{sec:blayer}. Dado que en tomografía óptica las fuentes y los detectores 
se ubican en el contorno del dominio a analizar, es esperable que una aproximación 
que no es apropiada en estas regiones tenga un impacto negativo significativo en las reconstrucciones obtenidas en problema inverso basado en la ecuación~\eqref{eq:difusion}. 
\pagebreak

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{El algoritmo FC(Gram)}
\label{ap:fcgram}

En la sección~\ref{sec:fcmethod} presentamos la estrategia de discretización 
para el tratamiento numérico de las derivadas espaciales en la ETR~\eqref{eq:RTE}. 
Como se mencionó en dicha sección, el algoritmo utilizado se basa 
en la generación de continuaciones de las funciones involucradas, 
que convierten dichas funciones no periódicas en funciones periódicas 
en un intervalo extendido. Para ello, se utilizan proyecciones en una base 
de polinomios Gram con continuaciones a cero~\cite{Amlani2016}. En esta sección damos algunos detalles 
adicionales para la generación de dichas bases de polinomios, y sus continuaciones a cero.

Dada una función $f(x)$ definida en una grilla discreta, $f:[0,1]\rightarrow \mathbb{R}$, 
con $f_j=f(x_j)$, $x_j=(j-1)/N,\;j=1,2,\ldots,N+1$, el método de continuación de 
Fourier genera una función continuada $f_c(x)$, la cual es periódica, posee 
derivadas suaves en el intervalo extendido $f_c: [0,b] \rightarrow \mathbb{R}$, con $f_{c,j}=f_c(x_j)$, $x_j=(j-1)/N,\;j=1,2,\ldots,N_p$, con 
$N_p=N+C+1$~\cite{Albin2011,Amlani2016}.

Esta función continuada es tal que su representación de Fourier (con $i$ la unidad imaginaria)
\begin{equation}
f_c(x)=\sum_{k=-N_p/2}^{N_p/2} a_k \exp\left( \frac{2\pi i k x}{b} \right),
\label{eq:fccont1}
\end{equation}
no presenta el fenómeno de Gibbs, de forma que las derivadas espaciales de $f(x)$ 
pueden calcularse eficientemente y con alta precisión a partir de la representación~\eqref{eq:fccont1} mediante uso de la transformada rápida de Fourier
\begin{equation}
\frac{df}{dx}(x)\simeq \frac{df_c}{dx}(x)=\sum_{k=-N_p/2}^{N_p/2} \frac{2\pi i k x}{b} a_k \exp\left( \frac{2\pi i k x}{b} \right),
\label{eq:fccont2}
\end{equation}
y donde se cumple qué la función continuada es igual a la función original en el intervalo $x\in[0,1]$, con $f_c(x_j)=f(x_j)$, $j=1,\ldots,N+1$.

Para obtener la continuación de Fourier $f_c$ de la función $f$ de manera computacionalmente eficiente, el método FC(Gram) utiliza únicamente información de unos pocos puntos en los bordes de $f$. 
El algoritmo procede mediante la proyección en polinomios Gram de los puntos de los extremos 
a derecha $\{x_{N+1-d_r},x_{N-d_r},\ldots, x_{N+1} \}$ y a izquierda $\{x_{1},x_{2},\ldots, x_{d_{\ell}} \}$.
La continuación a derecha es generada mediante la proyección en una dada base de polinomios 
a derecha $\mathcal{B}_r$, y la continuación a izquierda se produce mediante la proyección 
en polinomios de la base $\mathcal{B}_{\ell}$. 
La proyección en los polinomios $p_r \in \mathcal{B}_r$ genera una continuación que 
aproxima a la función $f$ en el intervalo $[1-\delta_r,1]$ y que se vuelve cero de 
forma suave en $x\ge b$, con $\delta_r=(d_r-1)h$. Para la continuación a izquierda, se considera 
la extensión periódica de $f$, con $f(x_j+b)=f(x_j)$, y similarmente, la proyección 
en dichos polinomios genera una aproximación a la función original en el intervalo $[b,b+\delta_{\ell}]$ ($\delta_{\ell}=(d_l-1)h$) la cual se anula suavemente en el intervalo $x\leq 1$ (donde el 
intervalo $[b,b+\delta_{\ell}]$ corresponde a la continuación periódica de la función original $f$, con $f(x_1)=f(x_1+b),f(x_2)=f(x_2+b),\ldots, f(x_{d_{\ell}})=f(x_{d_{\ell}}+b)$). 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

En esta tesis utilizamos $d_{\ell}=d_r=d=5$, de donde $\delta_r=\delta_{\ell}$.  
Como ejemplo mostraremos la construcción de la base 
de polinomios utilizada para la proyección y continuación a cero 
a la izquierda de la función $f$. El tratamiento para las continuaciones a derecha 
es análogo.
Consideramos el espacio de polinomios $P_d$ de grado $<d$ definidos en el intervalo $[0,\delta]$, con $\delta>0$ un número pequeño.

Para $g,h\in P_d$, $P_d=\{p_1,p_2,...,p_{d-1}\}$

\begin{equation}
\langle g,h\rangle =\sum_{j=1}^{d}g(x_j)h(x_j),
\label{eq:dotpd}
\end{equation}
define un producto escalar en la grilla discreta $x_1,x_2,\ldots,x_d$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 Definimos la matriz de Vandermonde
 \begin{equation}
\bar{P}=
\begin{bmatrix}
    1  & x_{1} & x_{1}^2 & \dots  & x_{1}^{d-1} \\
    1  & x_{2} & x_{2}^2 & \dots  & x_{2}^{d-1} \\
    \vdots  & \vdots & \ddots & \vdots \\
    1 & x_{d} & x_{d}^2 & \dots  & x_{d}^{d-1}
\end{bmatrix},
\label{eq:Vandermonde}
\end{equation}
con $\bar{P}\in\mathbb{R}^{d \times d}$. 
Dada la descomposición $\bar{P}=\bar{Q}\bar{R}$, con $\bar{Q}^T\bar{Q}= \id$ y $\bar{R}$ una matriz triangular superior, los vectores columna 
de la matriz $\bar{Q}$ satisfacen la relación de ortogonalidad con respecto al producto escalar 
(\ref{eq:dotpd}) 
\begin{equation*}
\displaystyle \langle q_i,q_k \rangle = \sum_{j=1}^{d}q_{i,j}q_{j,k}=\sum_{j=1}^{d}q_i(x_j)q_k(x_j)=\vec{q}_i^T\vec{q}_k=\delta_{i,k} ,
\end{equation*}
con $\delta_{i,k}$ la delta de 
Kronecker. 
La matriz $\bar{Q}$ contiene los polinomios Gram en sus columnas
\begin{equation}
\bar{Q}=
\begin{bmatrix}
    q_1(x_1) & q_2(x_1) & \dots  & q_{d}(x_1) \\
    q_1(x_2) & q_2(x_2) & \dots  & q_{d}(x_2) \\
    \vdots &  \vdots & \ddots & \vdots \\
    q_1(x_{d}) & q_2(x_{d}) & \dots  &q_{d}(x_{d})
\end{bmatrix}=[\vec{q}_1,\vec{q}_2,...,\vec{q}_{d}],
\label{eq:VandermondeQR}
\end{equation}

Si se considera a la matriz $\bar{P}$ como $\bar{P}=[\vec{p}_1,\vec{p}_2,...,\vec{p}_{d}]$ con $\vec{p}_i=[p_i(x_1),p_i(x_2),...,p_i(x_{d})]^T$, la base de polinomios $P_d$ podrá expresarse en la base de los polinomios ortogonales $\vec{q_i}$ como $\displaystyle \vec{p}_i=\sum_{j=1}^{i}r_{j,i}\vec{q}_j$. La matriz $\bar{R}$ contiene los coeficientes de esta expansión.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Las columnas de la matriz $\bar{Q}$ son los valores de los polinomios Gram ortogonales 
con respecto al producto escalar discreto~\eqref{eq:dotpd}.
Adicionalmente, se sobremuestrea la matriz $\bar{P}$, de forma qué 
$\bar{P}^s \in \mathbb{R}^{(N_s(d-1)+1)\times d}$, 
con la matriz de Vandermonde evaluada en la grilla numérica refinada $h'=h/N_s$. 
Los polinomios 
ortonormales sobremuestreados se obtienen de las columnas de $\bar{Q}^s$, con 
\begin{equation}
\bar{Q}^s=\bar{P}^s \bar{R}^{-1}
\label{eq:qsob}
\end{equation}
donde $\bar{R}$ se la matriz triangular superior que se obtiene 
mediante ortogonalización de la matriz $\bar{P}$ sin sobremuestreo. Dado 
que el problema de ortogonalización de la matriz de Vandermonde~\eqref{eq:Vandermonde} 
esta mal condicionado, la descomposición QR se realiza con alta precisión 
numérica (256 dígitos) mediante el método de ortogonalización de Gram-Schmidt.

El proceso de continuación puede expresarse mediante el operador de continuación $\bar{A}$
\begin{equation}
\vec{f}_c= 
\begin{bmatrix}
    \id \\
    \bar{A}  \\
\end{bmatrix}
\vec{f}=
\begin{bmatrix}
    \vec{f}\\
    \bar{A} \vec{f}  \\
\end{bmatrix}
,
\label{eq:FCopA}
\end{equation}
donde la matriz $\bar{A}$ es el operador que al aplicarse sobre 
el vector $\vec{f}$ de valores discretos de la función $f$ 
genera las continuaciones a cero a derecha y a izquierda, cuya suma 
da la extensión periódica de la función continuada
\begin{equation}
    \bar{A}  \vec{f} = \bar{A}_{\ell} \bar{Q}_{\ell}  \vec{f}_{\ell} 
+\bar{A}_{r} \bar{Q}_{r}  \vec{f}_{r}.
\label{eq:Acont}
\end{equation}
donde $\vec{f}_{\ell}=(f_1,f_2,\ldots,f_d)$, 
 $\vec{f}_{r}=(f_{N+1-d},f_{N-d},\ldots,f_{N+1})$ 
 son los valores de la función discreta utilizados para producir las continuaciones, $\bar{Q}_{\ell} $ y $\bar{Q}_{r}$ son las matrices obtenidas por factorización 
QR de los polinomios de Vandermonde correspondientes, y donde las matrices $\bar{A}_{\ell}$ 
y $\bar{A}_{r}$ generan las transiciones a cero a izquierda y derecha respectivamente, en el intervalo de continuación, 
y se obtienen de resolver un problema de minimización 
para el polinomio trigonométrico interpolante en la grilla numérica sobresampleada 
que coincide con los polinomios Gram en los $d$ puntos de la función $f$, y 
que se anula en la región de continuación
\begin{equation}
f(x)=\sum_{k=-M}^{M} a_k e^{\frac{2\pi i k x}{(d+C+Z+E-1)h}},
\label{eq:fccontint}
\end{equation}
donde $d$, $C$, $Z$ y $E$ representan los $d$ puntos de ajuste (para las continuaciones a izquierda, los puntos $\{x_{1},x_{2},\ldots, x_{d_{\ell}} \}$) de la función original, 
los $C$ puntos de continuación, $Z$ puntos donde se exige que la función se anule, $E$ 
puntos extra que permiten realizar continuaciones de longitud prescripta 
y $M=(d+C+Z+E)/2$ (para mas detalles, ver~\cite{Amlani2016}).

La ecuación~\eqref{eq:fccontint} puede escribirse
\begin{equation*}
f(x)=\bar{B}^s \vec{a}=
\begin{bmatrix}
    e^{\frac{-\pi M x_1}{(d+C+Z+E-1)h}}  & e^{\frac{-(M+2)\pi  x_1}{(d+C+Z+E-1)h}} & \dots & 
    e^{\frac{2\pi k x_1}{(d+C+Z+E-1)h}}  & \dots  & e^{\frac{M \pi  x_1}{(d+C+Z+E-1)h}} \\
    e^{\frac{-\pi M x_2}{(d+C+Z+E-1)h}}  & e^{\frac{-(M+2)\pi  x_2}{(d+C+Z+E-1)h}}  & \dots & 
    e^{\frac{2\pi k x_2}{(d+C+Z+E-1)h}}  & \dots  & e^{\frac{M \pi  x_2}{(d+C+Z+E-1)h}} \\
    \vdots  & \vdots & \ddots & \vdots \\
    e^{\frac{-\pi M x_j}{(d+C+Z+E-1)h}}  & e^{\frac{-(M+2)\pi  x_j}{(d+C+Z+E-1)h}}  & \dots & 
    e^{\frac{2\pi k x_j}{(d+C+Z+E-1)h}}  & \dots & e^{\frac{M \pi  x_j}{(d+C+Z+E-1)h}} \\
    \vdots  & \vdots & \ddots & \vdots \\
\end{bmatrix}
\begin{bmatrix}
    a_{-M/2}\\
    \vdots\\
    a_k\\
    \vdots\\
    a_{M/2} \\
\end{bmatrix},
\label{eq:fccontint2}
\end{equation*}
con $\vec{a}=(a_{-M/2},\ldots,a_{M/2})^T$. 
Luego, buscamos los coeficientes $\vec{a}$ que son solución de 
\begin{equation}
\text{argmin}_{\vec{a}=(a_{-M},\ldots,a_M)} \left | \left|\bar{B}^s \vec{a}-
\begin{bmatrix}
    \vec{q_j}^s(x)\\
    \vec{0} \\
\end{bmatrix}
\right|\right|_2,
\label{eq:SVD}
\end{equation}
la matriz $\bar{B}^s$ se obtiene 
de evaluar la función~\eqref{eq:fccontint} en los $d$ puntos de ajuste, y en los $Z$ puntos donde se fuerzan los polinomios a anularse, $ \vec{q_j}^s(x)$ son las columnas 
de la matriz $\bar{Q}^s$ en la ecuación~\eqref{eq:qsob} y $\vec{0}$ es el vector nulo de dimensión $(Z-1)\times N_s +1$. Los coeficientes de Fourier que minimizan la relación~\eqref{eq:SVD} se encuentran mediante descomposición en valores singulares (SVD). 
Las matrices $A_{\ell}$ y $A_r$ se obtienen, finalmente, de evaluar la relación~\eqref{eq:fccontint} con los coeficientes que resuelven~\eqref{eq:SVD} 
para todo el intervalo $[0,(d+C+Z+E-1)h]$.


Cabe destacar que este procedimiento  solo se usa para obtener un pequeño archivo de parámetros 
(el cual contiene los elementos de las matrices $A_{\ell}$ $Q_{\ell}$, $A_{r}$ y $Q_{r}$), que se incorpora como parte integrante de la subrutina FC, y subsiguientemente se utiliza para la aplicación de la rutina en la expansión de cualquier función discreta $f$---de acuerdo a la ec.~\eqref{eq:FCopA}.  

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Resolución de capa límite}
\label{ap:demcv}
Como se vio en la sección~\ref{sec:blayer}, las soluciones de la ETR presentan 
estructuras de capa límite tanto en las variables espaciales como en la variable angular, $\xi$. 
En esa sección se vio que la introducción de un cambio de variable logarítmico (otros cambios 
de variable también son posibles) generan una densidad de puntos espaciales en la cercanía 
del borde de forma que la capa límite puede ser resuelta apropiadamente en 
la variable espacial. Adicionalmente, dicho cambio 
de variable genera puntos extremadamente cercanos al borde. Para que la integral colisional sea correctamente 
resuelta en las proximidades del borde, se propuso el cambio de variable $\xi'=r^n$. 
Esta sección provee una demostración matemática de que la combinación del cambio 
de variable espacial, en conjunto con el cambio de variable $\xi'=r^n$ utilizado 
en la sección~\ref{sec:blayer} regulariza las derivadas 
del integrando en $\int_0^1 u_0(x,\xi)d\xi' = \int_0^1  u_0(x,r^n) r^{n-1} dr$ (la demostración 
para la integral complementaria  $\int_{-1}^0 u_0(x,\xi)d\xi'$ es análoga). 

Partimos de la solución asintótica para la capa límite~\eqref{eq:intf}
\begin{equation}
u_0(x,\xi) = \frac{e^{-\mu_t(0)x/\xi}}{\xi} \left(\xi u_0(0,\xi) + \int_0^{x} e^{\mu_t(0)\frac{y}{\xi}} \left[ \frac{\mu_s(0)}{2} \int_{-1}^1 u_0(y,\xi')d\xi' +q(0,\xi) \right] dy\right)
\label{eq:ecss}
\end{equation}
y reescribimos
\begin{equation}
u_0(x,r^n) = \frac{e^{-\mu_t(0)x/r^n}}{r^n} \left(r^n u_0(0,r^n) + \int_0^{x} e^{\mu_t(0)\frac{y}{r^n}} \left[ \frac{\mu_s(0)}{2} \int_{-1}^1 u_0(y,\xi')d\xi' +q(0,r^n) \right] dy\right).
\label{eq:ecsscv}
\end{equation}
Usamos
\begin{equation*}
\begin{split}
\int_0^{x} e^{\mu_t(0)\frac{y}{r^n}}q(0,\xi)dy=r^n\frac{q(0,\xi)}{\mu_t(0)}(e^{\mu_t(0)x/r^n}-1).
\end{split}
\raisetag{50pt}
\label{eq:boundedder2}
\end{equation*}
Y reescribimos
\begin{equation}
\begin{split}
u_0(x,r^n)& =\frac{e^{-\mu_t(0)x/r^n}}{r^n} \left(r^n u_0(0,r^n) +  r^n\frac{q(0,\xi)}{\mu_t(0)}(e^{\mu_t(0)x/r^n}-1) + \int_0^{x} e^{\mu_t(0)\frac{y}{r^n}} \left[ \frac{\mu_s(0)}{2} \int_{-1}^1 u_0(y,\xi')d\xi' \right] dy\right).
\end{split}
\label{eq:ecss2}
\end{equation}
Considerando el integrando del término colisional con el cambio de variable $\xi=r^n$, necesitamos mostrar que las derivadas de dicho integrando 
estarán acotadas bajo el cambio de variable, para lo cual debemos calcular
\begin{equation}
\begin{split}
\frac{d }{dr} \left( u_0(x,r^n) r^{n-1} \right)=&\frac{d }{dr} \Bigg\{ 
u_0(0,r^n) e^{-\mu_t(0)x/r^n}r^{n-1} + \frac{q(0,r^n)}{\mu_t(0)}\left(1-e^{-\mu_t(0)x/r^n}\right)r^{n-1}  \Bigg.\\
&+r^{-1}e^{-\mu_t(0)x/r^n}  \int_0^{x} e^{\mu_t(0)\frac{y}{r^n}} \left[ \frac{\mu_s(0)}{2} \int_{-1}^1 u_0(y,\xi')d\xi' \right] dy \Bigg. \Bigg\}\\
\end{split}
\label{eq:boundedder}
\end{equation}
Llamamos $\phi(y)=\int_{-1}^1 u_0(y,\xi')d\xi'$ al término colisional
\begin{equation}
\begin{split}
\frac{d }{dr} \left( u_0(x,r^n) r^{n-1} \right)=&\frac{d }{dr} \Bigg\{ 
u_0(0,r^n) e^{-\mu_t(0)x/r^n}r^{n-1} + \frac{q(0,r^n)}{\mu_t(0)}\left(1-e^{-\mu_t(0)x/r^n}\right)r^{n-1}  \Bigg.\\
&+ \frac{\mu_s(0)}{2} \int_0^{x} \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r} \phi(y) dy \Bigg. \Bigg\}
\end{split}
\label{eq:boundedder2}
\end{equation}
Por otra parte, tenemos las derivadas:
\begin{equation}
\begin{split}
\xi(r)=&r^n,\\
\frac{d }{dr}\xi'(r)=&nr^{n-1},\\
\frac{d }{dr} r^{n-1}=&(n-1)r^{n-2},\\
\frac{d }{dr} e^{-\mu_t(0)x/r^n}=&\frac{\mu_t(0)nx}{r^{n+1}}e^{-\mu_t(0)x/r^n},\\
\frac{d }{dr} u_0(0,r^n)=&\frac{\partial u_0(0,\xi(r))}{\partial \xi}nr^{n-1},\\
\frac{d }{dr}\left[\frac{q(0,r^n)}{\mu_t(0)}(1-e^{-\mu_t(0)x/r^n}) \right]=&
\frac{1}{\mu_t(0)}\frac{\partial q(0,\xi(r))}{\partial \xi} nr^{n-1} (1-e^{-\mu_t(0)x/r^n})-q(0,r^n)\frac{nx}{r^{n+1}}e^{-\mu_t(0)x/r^n}\\
\frac{d }{dr}\left( \int_0^{x} \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r} \phi(y) dy \right) =& \int_0^{x} \frac{d }{dr}\left(  \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r} \right) \phi(y) dy\\
=&\int_0^{x} \frac{1}{r^2} \left(-n(y-x) \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r^n}
- e^{\mu_t(0)\frac{(y-x)}{r^n}}\right)  \phi(y) dy
\end{split}
\label{eq:derivadas}
\end{equation}
De las derivadas en~\eqref{eq:derivadas} tenemos
\begin{equation}
\begin{split}
\frac{d }{dr} \left[ 
u_0(0,r^n)r^{n-1}e^{-\mu_t(0)x/r^n} \right]=
n\frac{\partial u_0(0,\xi(r))}{\partial \xi}r^{2n-2}&e^{-\mu_t(0)x/r^n} + (n-1) r^{n-2}u_0(0,r^n)e^{-\mu_t(0)x/r^n}\\&+ u_0(0,r^n)\frac{\mu_t(0)nx}{r^{2}}e^{-\mu_t(0)x/r^n}
\end{split}
\label{eq:derivadas2}
\end{equation}

\begin{equation}
\begin{split}
\frac{d }{dr} \left[ r^{n-1}\frac{q(0,r^n)}{\mu_t(0)}\left(1-e^{-\mu_t(0)x/r^n}\right)
\right]=&
 (n-1)r^{n-2}\frac{q(0,r^n)}{\mu_t(0)} \left( 1-e^{-\mu_t(0)x/r^n} \right)\\ 
 &+\frac{1}{\mu_t(0)}\frac{\partial q(0,\xi(r))}{\partial \xi} nr^{2n-2} (1-e^{-\mu_t(0)x/r^n})\\&-q(0,r^n)\frac{nx}{r^{2}}e^{-\mu_t(0)x/r^n}
\end{split}
\label{eq:derivadas3}
\end{equation}
Introduciendo en \eqref{eq:boundedder2} las relaciones auxiliares en \eqref{eq:derivadas} a \eqref{eq:derivadas3} se llega a
\begin{equation}
\begin{split}
\frac{d }{dr} & \left( u_0(x,r^n) r^{n-1} \right)=
n\frac{\partial u_0(0,\xi(r))}{\partial \xi}r^{2n-2}e^{-\mu_t(0)x/r^n} - (n-1) r^{n-2}u_0(0,r^n)e^{-\mu_t(0)x/r^n}\\
&+u_0(0,r^n)\frac{\mu_t(0)nx}{r^{2}}e^{-\mu_t(0)x/r^n}+ (n-1)r^{n-2}\frac{q(0,r^n)}{\mu_t(0)} \left( 1-e^{-\mu_t(0)x/r^n} \right)\\
&+\frac{1}{\mu_t(0)}\frac{\partial q(0,\xi(r))}{\partial \xi} nr^{2n-2} (1-e^{-\mu_t(0)x/r^n})-q(0,r^n)\frac{nx}{r^{2}}e^{-\mu_t(0)x/r^n}\\
&+\frac{\mu_s(0)}{2} \int_0^{x} \frac{1}{r^2} \left(-n(y-x) \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r^n}
- e^{\mu_t(0)\frac{(y-x)}{r^n}}\right)  \phi(y) dy
\end{split}
\label{eq:boundedder3}
\end{equation}
Luego
\begin{equation}
\begin{split}
 \Bigg| \frac{d }{dr}& \left( u_0(x,r^n) r^{n-1} \right) \Bigg| \leq 
 \Bigg| n\frac{\partial u_0(0,\xi(r))}{\partial \xi}r^{2n-2}e^{-\mu_t(0)x/r^n}\Bigg|\\
&+\Bigg| (n-1) r^{n-2}u_0(0,r^n)e^{-\mu_t(0)x/r^n}\Bigg| +\Bigg|u_0(0,r^n)\frac{\mu_t(0)nx}{r^{2}}e^{-\mu_t(0)x/r^n}\Bigg|\\
& + \Bigg|(n-1)r^{n-2}\frac{q(0,r^n)}{\mu_t(0)} \left( 1+e^{-\mu_t(0)x/r^n} \right)\Bigg|+
\Bigg|\frac{1}{\mu_t(0)}\frac{\partial q(0,\xi(r))}{\partial \xi} nr^{2n-2} (1+e^{-\mu_t(0)x/r^n})\Bigg|\\&+\Bigg|q(0,r^n)\frac{nx}{r^{2}}e^{-\mu_t(0)x/r^n}\Bigg|+\Bigg| \frac{\mu_s(0)}{2} \int_0^{x} \frac{1}{r^2} \left(-n(y-x) \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r^n}
- e^{\mu_t(0)\frac{(y-x)}{r^n}}\right)  \phi(y) dy \Bigg|
\end{split}
\label{eq:bounding}
\end{equation}
Para todos los problemas físicamente admisible, sabemos que la 
integral $\phi(y)$ estará acotada, donde existirá
\begin{equation}
M=\text{max}~\phi(y),
\end{equation}
y dado qué $\phi(y)\leq M$, tenemos
\begin{equation}
\begin{split}
 \Bigg| \frac{d }{dr}& \left( u_0(x,r^n) r^{n-1} \right) \Bigg| \leq 
 \Bigg| n\frac{\partial u_0(0,\xi(r))}{\partial \xi}r^{2n-2}e^{-\mu_t(0)x/r^n}\Bigg|\\
&+\Bigg| (n-1) r^{n-2}u_0(0,r^n)e^{-\mu_t(0)x/r^n}\Bigg| +\Bigg|u_0(0,r^n)\frac{\mu_t(0)nx}{r^{2}}e^{-\mu_t(0)x/r^n}\Bigg|\\
& + \Bigg|(n-1)r^{n-2}\frac{q(0,r^n)}{\mu_t(0)} \left( 1+e^{-\mu_t(0)x/r^n} \right)\Bigg|+
\Bigg|\frac{1}{\mu_t(0)}\frac{\partial q(0,\xi(r))}{\partial \xi} nr^{2n-2} (1+e^{-\mu_t(0)x/r^n})\Bigg|\\&+\Bigg|q(0,r^n)\frac{nx}{r^{2}}e^{-\mu_t(0)x/r^n}\Bigg|+\frac{\mu_s(0)}{2}\frac{M}{r^2}  \int_0^{x} \Bigg| n(y-x) \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r^n}\Bigg| dy 
+ \frac{\mu_s(0)}{2} \frac{M}{r^2} \int_0^{x} \Bigg| e^{\mu_t(0)\frac{(y-x)}{r^n}} \Bigg| dy 
\end{split}
\label{eq:bounding2}
\end{equation}
Usamos el cambio de variable $\mu_t(0)(y-x)/r^n=-t$, $dy=r^n dt/\mu_t(0)$ para tener
\begin{equation}
\begin{split}
\frac{M}{r^2}  \int_0^{x} \Bigg| n(y-x) \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r^n}\Bigg| dy=&\frac{M r^n}{\mu_t(0) r^2}  \int_0^{\mu_t(0)x/r^n} | te^{-t} |dt \\
\frac{M}{r^2} \int_0^{x} \Bigg| e^{\mu_t(0)\frac{(y-x)}{r^n}} \Bigg| dy 
=&\frac{M r^n}{\mu_t(0) r^2}  \int_0^{\mu_t(0) x/r^n} |e^{-t}|dt \\
\end{split}
\label{eq:bounding2aux}
\end{equation}
Y resulta
\begin{equation}
\begin{split}
 \Bigg| \frac{d }{dr}& \left( u_0(x,r^n) r^{n-1} \right) \Bigg| \leq 
 \Bigg| n\frac{\partial u_0(0,\xi(r))}{\partial \xi}r^{2n-2}e^{-\mu_t(0)x/r^n}\Bigg| +\Bigg| (n-1) r^{n-2}u_0(0,r^n)e^{-\mu_t(0)x/r^n}\Bigg|\\
& +\Bigg|u_0(0,r^n)\frac{\mu_t(0)nx}{r^{2}}e^{-\mu_t(0)x/r^n}\Bigg|\\
& + \Bigg|(n-1)r^{n-2}\frac{q(0,r^n)}{\mu_t(0)} \left( 1+e^{-\mu_t(0)x/r^n} \right)\Bigg|+
\Bigg|\frac{1}{\mu_t(0)}\frac{\partial q(0,\xi(r))}{\partial \xi} nr^{2n-2} (1+e^{-\mu_t(0)x/r^n})\Bigg|\\&+\Bigg|q(0,r^n)\frac{nx}{r^{2}}e^{-\mu_t(0)x/r^n}\Bigg|+\frac{\mu_s(0)}{2}\frac{M r^n}{\mu_t(0) r^2}  \int_0^{\mu_t(0)x/r^n} | te^{-t} |dt 
+ \frac{\mu_s(0)}{2} \frac{M r^n}{\mu_t(0)r^2}  \int_0^{\mu_t(0)x/r^n} |e^{-t}|dt
\end{split}
\label{eq:bounding2}
\end{equation}
Donde todos los términos están acotados para $n\geq 2$.

Vamos a probar la cota para la derivada $j$-esima. Se prueba por inducción. 

Reescribimos \eqref{eq:boundedder2} como
\begin{equation}
\begin{split}
\frac{d^j }{dr^j} \left( u_0(x,r^n) r^{n-1} \right)=&\frac{d^j }{dr^j} \Bigg\{ 
\left[u_0(0,r^n) + \frac{q(0,r^n)}{\mu_t(0)}e^{\mu_t(0)x/r^n}-\frac{q(0,r^n)}{\mu_t(0)} \right]r^{n-1}e^{-\mu_t(0)x/r^n}   \Bigg.\\
&+ \frac{\mu_s(0)}{2} \int_0^{x} \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r} \phi(y) dy \Bigg. \Bigg\}\\
&=\frac{d^j }{dr^j} \Bigg\{ 
\left[u_0(0,r^n) -\frac{q(0,r^n)}{\mu_t(0)} \right]r^{n-1}e^{-\mu_t(0)x/r^n} + \frac{q(0,r^n)}{\mu_t(0)}r^{n-1}   \Bigg.\\
&+ \frac{\mu_s(0)}{2} \int_0^{x} \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r} \phi(y) dy \Bigg. \Bigg\}\\
\end{split}
\label{eq:boundedder3}
\end{equation}
Para el último término usamos
\begin{equation}
\begin{split}
\frac{d^j }{dr^j} \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r}=&  \frac{1}{r^{j+1}}\sum_{l=1}^j c_l \left( \mu_t(0)\frac{(y-x)}{r^n} \right)^l e^{\mu_t(0)\frac{(y-x)}{r^n}}
\end{split}
\label{eq:derivadasj}
\end{equation}
Es fácil probar que vale para $j=1$, luego vemos que vale para $j$, 
y finalmente derivando para $j$ vemos que entonces se cumple para $j+1$.
Tenemos
\begin{equation}
\begin{split}
\frac{d^j }{dr^j}\left( \int_0^{x} \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r} \phi(y) dy \right) =& \int_0^{x} \frac{d^j }{dr^j}\left(  \frac{e^{\mu_t(0)\frac{(y-x)}{r^n}}}{r} \right) \phi(y) dy\\
=&\int_0^{x} \phi(y)  \frac{1}{r^{j+1}}\sum_{l=1}^j c_l \left( \mu_t(0)\frac{(y-x)}{r^n} \right)^l e^{\mu_t(0)\frac{(y-x)}{r^n}}dy\\
=&\int_0^{\mu_t(0)x/r^n} \phi\left(x-\frac{r^n}{\mu_t(0)}\right)  \frac{\mu_t(0) r^n}{r^{j+1}}\sum_{l=1}^j c_l \left( -t \right)^l e^{-t}dt
\end{split}
\label{eq:derivadasj2}
\end{equation}
Este término estará acotado para $n\ge j+1$ (para cualquier entero no negativo $k$ 
la integral $\int_0^\infty t^k e^{-t} dt$ es acotada).

Para los términos que quedan, debemos utilizar una combinación de la regla generalizada 
para la derivada del 
del producto de funciones, en conjunto con la fórmula de Faà di Bruno 
para las derivadas de las funciones compuestas. Pero se ve claramente que, de entre estos términos, el término 
que va a determinar la relación asintótica para $r \to 0$ es el que surge de 
tomar la derivada $j$-ésima para $r^{n-1}$ en el producto $\frac{q(0,r^n)}{\mu_t(0)}r^{n-1}$, ya que los otros términos están multiplicados por exponenciales negativas 
que van a cancelar cualquier $r^{-p}$ que pueda surgir. 

Dado qué 
\begin{equation}
\begin{split}
\frac{d^j }{dr^j} r^{n-1}= \prod_{i=1}^j (n-i)r^{n-j-1}.
\end{split}
\label{eq:derivadasj3}
\end{equation}
de donde claramente el término dominante estará acotado siempre que 
$n\ge j+1$. $\blacksquare$

\pagestyle{empty}

